<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Plan Generator - Versione Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --dark: #1a202c;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-600: #718096;
            --gray-800: #2d3748;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-lg: 0 25px 50px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .progress-container {
            background: var(--gray-100);
            border-radius: 50px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            border-radius: 50px;
            transition: width 0.3s ease;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        .form-section {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .step.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            transform: scale(1.1);
        }

        .step.completed {
            background: var(--success);
            color: var(--white);
        }

        .step.inactive {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .step::after {
            content: '';
            width: 40px;
            height: 2px;
            background: var(--gray-300);
            position: absolute;
            right: -27px;
            top: 50%;
        }

        .step:last-child::after {
            display: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .kpi-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .kpi-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .kpi-item:hover {
            transform: translateY(-2px);
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-generate {
            background: linear-gradient(135deg, var(--success), #38a169);
            font-size: 18px;
            padding: 20px 40px;
        }

        .preview-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .document-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .doc-type-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-300);
            background: var(--white);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .doc-type-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .preview-content {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 15px;
            font-size: 12px;
            line-height: 1.5;
            height: 200px;
            overflow-y: auto;
            white-space: pre-line;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .storage-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .scenario-section {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .scenario-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid var(--gray-300);
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .document-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .document-card:hover {
            transform: translateY(-5px);
        }

        .document-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .document-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 20px;
        }

        .cashflow-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 20px;
        }

        .cashflow-table th {
            background: var(--gray-100);
            padding: 12px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-800);
            text-align: center;
        }

        .cashflow-table td {
            background: var(--white);
            padding: 10px 8px;
            text-align: center;
            font-size: 11px;
            border: 1px solid var(--gray-200);
        }

        .success-message {
            background: linear-gradient(135deg, var(--success), #38a169);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Business Plan Generator</h1>
            <p>Generatore professionale di documenti finanziari - Crea business plan e analisi complete</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="main-content">
            <!-- Form Section -->
            <div class="form-section">
                <div class="step-indicator">
                    <div class="step active" data-step="0">1</div>
                    <div class="step inactive" data-step="1">2</div>
                    <div class="step inactive" data-step="2">3</div>
                    <div class="step inactive" data-step="3">4</div>
                </div>

                <div id="stepContent"></div>

                <div class="navigation">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" disabled>
                        ‚Üê Indietro
                    </button>
                    <button class="btn" id="nextBtn" onclick="nextStep()">
                        Avanti ‚Üí
                    </button>
                </div>

                <div class="storage-controls">
                    <button class="btn btn-secondary" onclick="saveData()">üíæ Salva</button>
                    <button class="btn btn-secondary" onclick="loadData()">üìÇ Carica</button>
                    <button class="btn btn-secondary" onclick="exportJSON()">‚¨áÔ∏è Esporta</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Importa</button>
                    <button class="btn" style="background: var(--danger)" onclick="resetAll()">üßπ Reset</button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="kpi-card">
                    <h3>üìä KPI Real-time</h3>
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-value" id="kpiEbitda">‚Ç¨0</div>
                            <div class="kpi-label">EBITDA</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value" id="kpiGrowth">0%</div>
                            <div class="kpi-label">Crescita</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value" id="kpiMargin">0%</div>
                            <div class="kpi-label">Margine</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value" id="kpiCash">‚Ç¨0</div>
                            <div class="kpi-label">Cassa 12M</div>
                        </div>
                    </div>
                </div>

                <div class="preview-card">
                    <h3>üëÄ Anteprima Live</h3>
                    <div class="document-type-selector">
                        <button class="doc-type-btn active" data-type="analisi">Analisi</button>
                        <button class="doc-type-btn" data-type="bp">Business</button>
                        <button class="doc-type-btn" data-type="cashflow">Cashflow</button>
                        <button class="doc-type-btn" data-type="fattibilita">Fattibilit√†</button>
                    </div>
                    <div class="preview-content" id="previewContent">
                        Compila i dati per vedere l'anteprima...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATO GLOBALE
        // ============================================
        let currentStep = 0;
        let companyData = {
            // Dati aziendali base
            ragioneSociale: '',
            settore: '',
            anniAttivita: '',
            dipendenti: '',
            fatturato2024: '',
            fatturato2023: '',
            fatturato2022: '',
            costiFissi: '',
            costiVariabili: '',
            
            // Situazione finanziaria  
            liquidita: '',
            immobilizzazioni: '',
            debiti: '',
            crediti: '',
            crescitaPrevista: '',
            mercatoTarget: '',
            
            // Progetto e scenari
            descrizioneProgetto: '',
            investimentoRichiesto: '',
            ritornoInvestimento: '',
            tempiRealizzazione: '',
            
            // Scenari differenziali
            scenarioA_volumi: '',
            scenarioA_crescita: '',
            scenarioA_prezzo: '',
            scenarioB_volumi: '',
            scenarioB_crescita: '',
            scenarioB_prezzo: ''
        };

        let calculations = {};
        let generatedDocs = [];

        // ============================================
        // STEP MANAGEMENT
        // ============================================

        const stepContents = [
            {
                title: "üìã Dati Aziendali di Base",
                fields: [
                    {name: 'ragioneSociale', label: 'Ragione Sociale', type: 'text', placeholder: 'Es. MNS Group S.r.l.'},
                    {name: 'settore', label: 'Settore', type: 'select', options: [
                        {value: '', label: 'Seleziona settore'},
                        {value: 'Tecnologia', label: 'Tecnologia'},
                        {value: 'Manifatturiero', label: 'Manifatturiero'},
                        {value: 'Servizi', label: 'Servizi'},
                        {value: 'Commercio', label: 'Commercio'},
                        {value: 'Edilizia', label: 'Edilizia'},
                        {value: 'Agricoltura', label: 'Agricoltura'}
                    ]},
                    {name: 'anniAttivita', label: 'Anni di Attivit√†', type: 'number', placeholder: '15'},
                    {name: 'dipendenti', label: 'Numero Dipendenti', type: 'number', placeholder: '25'},
                    {name: 'fatturato2024', label: 'Fatturato 2024 (‚Ç¨)', type: 'number', placeholder: '2500000'},
                    {name: 'fatturato2023', label: 'Fatturato 2023 (‚Ç¨)', type: 'number', placeholder: '2200000'},
                    {name: 'fatturato2022', label: 'Fatturato 2022 (‚Ç¨)', type: 'number', placeholder: '2000000'},
                    {name: 'costiFissi', label: 'Costi Fissi Annui (‚Ç¨)', type: 'number', placeholder: '800000'},
                    {name: 'costiVariabili', label: 'Costi Variabili Annui (‚Ç¨)', type: 'number', placeholder: '1200000'}
                ]
            },
            {
                title: "üí∞ Situazione Finanziaria",
                fields: [
                    {name: 'liquidita', label: 'Liquidit√† Disponibile (‚Ç¨)', type: 'number', placeholder: '500000'},
                    {name: 'immobilizzazioni', label: 'Immobilizzazioni (‚Ç¨)', type: 'number', placeholder: '1200000'},
                    {name: 'debiti', label: 'Debiti Totali (‚Ç¨)', type: 'number', placeholder: '600000'},
                    {name: 'crediti', label: 'Crediti (‚Ç¨)', type: 'number', placeholder: '400000'},
                    {name: 'crescitaPrevista', label: 'Crescita Prevista 2025 (%)', type: 'number', placeholder: '12'},
                    {name: 'mercatoTarget', label: 'Mercato Target', type: 'text', placeholder: 'Europa del Sud'}
                ]
            },
            {
                title: "üéØ Progetto di Investimento & Scenari",
                fields: [
                    {name: 'descrizioneProgetto', label: 'Descrizione Progetto', type: 'textarea', placeholder: 'Descrivi il progetto di investimento...'},
                    {name: 'investimentoRichiesto', label: 'Investimento Richiesto (‚Ç¨)', type: 'number', placeholder: '750000'},
                    {name: 'ritornoInvestimento', label: 'ROI Atteso (%)', type: 'number', placeholder: '18'},
                    {name: 'tempiRealizzazione', label: 'Tempi Realizzazione (mesi)', type: 'number', placeholder: '18'}
                ],
                showScenarios: true
            },
            {
                title: "üìÑ Documenti Generati",
                isDocuments: true
            }
        ];

        function renderStep() {
            const content = document.getElementById('stepContent');
            const step = stepContents[currentStep];
            
            if (step.isDocuments) {
                renderDocuments();
                return;
            }

            let html = `<h2>${step.title}</h2>`;
            
            if (step.fields) {
                html += '<div class="form-grid">';
                step.fields.forEach(field => {
                    html += `<div class="form-group">
                        <label>${field.label}</label>`;
                    
                    if (field.type === 'select') {
                        html += `<select name="${field.name}" onchange="updateFormData('${field.name}', this.value)">`;
                        field.options.forEach(option => {
                            html += `<option value="${option.value}" ${companyData[field.name] === option.value ? 'selected' : ''}>${option.label}</option>`;
                        });
                        html += '</select>';
                    } else if (field.type === 'textarea') {
                        html += `<textarea name="${field.name}" placeholder="${field.placeholder}" rows="4" onchange="updateFormData('${field.name}', this.value)">${companyData[field.name]}</textarea>`;
                    } else {
                        html += `<input type="${field.type}" name="${field.name}" value="${companyData[field.name]}" placeholder="${field.placeholder}" onchange="updateFormData('${field.name}', this.value)">`;
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }

            if (step.showScenarios) {
                html += renderScenarios();
            }

            if (currentStep === 2) {
                html += `<div style="margin-top: 30px;">
                    <button class="btn btn-generate" onclick="generateDocuments()" style="width: 100%;">
                        üöÄ Genera Documenti
                    </button>
                </div>`;
            }

            content.innerHTML = html;
            updateStepIndicator();
            updateNavigation();
        }

        function renderScenarios() {
            return `
                <div class="scenario-section">
                    <h3>üîÑ Analisi Scenari Differenziali</h3>
                    <div class="scenario-grid">
                        <div class="scenario-card">
                            <h4>Scenario A - Conservativo</h4>
                            <div class="form-group">
                                <label>Volumi Iniziali</label>
                                <input type="number" name="scenarioA_volumi" value="${companyData.scenarioA_volumi}" placeholder="100" onchange="updateFormData('scenarioA_volumi', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Crescita Mensile (%)</label>
                                <input type="number" name="scenarioA_crescita" value="${companyData.scenarioA_crescita}" placeholder="5" onchange="updateFormData('scenarioA_crescita', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Prezzo Unitario (‚Ç¨)</label>
                                <input type="number" name="scenarioA_prezzo" value="${companyData.scenarioA_prezzo}" placeholder="50" onchange="updateFormData('scenarioA_prezzo', this.value)">
                            </div>
                        </div>
                        <div class="scenario-card">
                            <h4>Scenario B - Ottimistico</h4>
                            <div class="form-group">
                                <label>Volumi Iniziali</label>
                                <input type="number" name="scenarioB_volumi" value="${companyData.scenarioB_volumi}" placeholder="120" onchange="updateFormData('scenarioB_volumi', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Crescita Mensile (%)</label>
                                <input type="number" name="scenarioB_crescita" value="${companyData.scenarioB_crescita}" placeholder="7" onchange="updateFormData('scenarioB_crescita', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Prezzo Unitario (‚Ç¨)</label>
                                <input type="number" name="scenarioB_prezzo" value="${companyData.scenarioB_prezzo}" placeholder="55" onchange="updateFormData('scenarioB_prezzo', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDocuments() {
            const content = document.getElementById('stepContent');
            
            if (generatedDocs.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--gray-600);">
                        <h2>üìÑ Nessun documento generato</h2>
                        <p>Torna allo step precedente e clicca "Genera Documenti"</p>
                        <button class="btn" onclick="previousStep()">‚Üê Torna Indietro</button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="success-message">
                    <h3>‚úÖ Documenti generati con successo!</h3>
                    <p>I tuoi documenti professionali sono pronti per il download</p>
                </div>
                <h2>üìÑ Documenti Generati</h2>
                <div class="documents-grid">
            `;

            generatedDocs.forEach((doc, index) => {
                html += `
                    <div class="document-card">
                        <div class="document-header">
                            <div class="document-icon">${doc.icon}</div>
                            <h3>${doc.name}</h3>
                        </div>
                        <div class="preview-content" style="height: 150px;">
                            ${doc.content.substring(0, 400)}...
                        </div>
                        <button class="btn" onclick="downloadPDF(${index})" style="width: 100%; margin-top: 15px;">
                            üì• Scarica PDF
                        </button>
                    </div>
                `;
            });

            html += '</div>';

            // Add cashflow table
            html += `
                <div style="margin-top: 30px; background: var(--white); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);">
                    <h3>üìä Rendiconto Finanziario (12 mesi)</h3>
                    <div style="overflow-x: auto;">
                        ${generateCashflowTable()}
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        // ============================================
        // DOCUMENT GENERATION
        // ============================================

        function generateDocuments() {
            showGenerationProgress();
            
            setTimeout(() => {
                generatedDocs = [
                    {
                        name: 'Analisi Differenziale',
                        icon: 'üìä',
                        content: generateAnalisiDifferenziale()
                    },
                    {
                        name: 'Business Plan',
                        icon: 'üìã',
                        content: generateBusinessPlan()
                    },
                    {
                        name: 'Rendiconto Finanziario',
                        icon: 'üí∞',
                        content: generateCashflowDocument()
                    },
                    {
                        name: 'Studio di Fattibilit√†',
                        icon: 'üîç',
                        content: generateStudioFattibilita()
                    }
                ];
                
                currentStep = 3;
                renderStep();
            }, 2000);
        }

        function showGenerationProgress() {
            const content = document.getElementById('stepContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 60px;">
                    <div style="width: 80px; height: 80px; border: 4px solid var(--gray-200); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <h2>üöÄ Generazione in corso...</h2>
                    <p>Elaborazione dati e creazione documenti professionali</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
        }

        function generateAnalisiDifferenziale() {
            return `ANALISI DIFFERENZIALE AZIENDALE
${companyData.ragioneSociale || '[Nome Azienda]'}
Data: ${new Date().toLocaleDateString('it-IT')}

PERFORMANCE ULTIMI 3 ANNI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ 2022: ‚Ç¨${formatNumber(companyData.fatturato2022)}
‚Ä¢ 2023: ‚Ç¨${formatNumber(companyData.fatturato2023)}
‚Ä¢ 2024: ‚Ç¨${formatNumber(companyData.fatturato2024)}

INDICATORI CHIAVE DI PERFORMANCE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Crescita YoY: ${calculations.crescita?.toFixed(2)}%
‚Ä¢ Margine EBITDA: ${calculations.margine?.toFixed(2)}%
‚Ä¢ EBITDA: ‚Ç¨${formatNumber(calculations.ebitda)}
‚Ä¢ Settore: ${companyData.settore}
‚Ä¢ Dipendenti: ${companyData.dipendenti}

CONFRONTO SCENARI DIFFERENZIALI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

SCENARIO A (Conservativo):
‚Ä¢ Volumi iniziali: ${companyData.scenarioA_volumi} unit√†
‚Ä¢ Crescita mensile: ${companyData.scenarioA_crescita}%
‚Ä¢ Prezzo unitario: ‚Ç¨${companyData.scenarioA_prezzo}
‚Ä¢ Revenue potenziale 12M: ‚Ç¨${formatNumber((companyData.scenarioA_volumi || 0) * (companyData.scenarioA_prezzo || 0) * 12)}

SCENARIO B (Ottimistico):
‚Ä¢ Volumi iniziali: ${companyData.scenarioB_volumi} unit√†
‚Ä¢ Crescita mensile: ${companyData.scenarioB_crescita}%
‚Ä¢ Prezzo unitario: ‚Ç¨${companyData.scenarioB_prezzo}
‚Ä¢ Revenue potenziale 12M: ‚Ç¨${formatNumber((companyData.scenarioB_volumi || 0) * (companyData.scenarioB_prezzo || 0) * 12)}

SITUAZIONE PATRIMONIALE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Liquidit√†: ‚Ç¨${formatNumber(companyData.liquidita)}
‚Ä¢ Immobilizzazioni: ‚Ç¨${formatNumber(companyData.immobilizzazioni)}
‚Ä¢ Crediti: ‚Ç¨${formatNumber(companyData.crediti)}
‚Ä¢ Debiti: ‚Ç¨${formatNumber(companyData.debiti)}

RACCOMANDAZIONI STRATEGICHE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Implementare Scenario B per massimizzare il ROI
‚úÖ Monitorare KPI mensili per mantenersi on-track
‚úÖ Ottimizzare mix prodotto/servizio per incrementare margini
‚úÖ Valutare opportunit√† di espansione nel mercato ${companyData.mercatoTarget}

CONCLUSIONI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
L'analisi differenziale evidenzia una posizione competitiva solida con 
significative opportunit√† di crescita. La scelta tra scenari dipender√† 
dalla disponibilit√† di risorse e dalla tolleranza al rischio.`;
        }

        function generateBusinessPlan() {
            return `BUSINESS PLAN ESECUTIVO
${companyData.ragioneSociale || '[Nome Azienda]'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

EXECUTIVE SUMMARY:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${companyData.descrizioneProgetto || 'Progetto di crescita e innovazione nel settore ' + companyData.settore}

L'azienda opera da ${companyData.anniAttivita} anni nel settore ${companyData.settore} 
con un team di ${companyData.dipendenti} dipendenti. L'investimento richiesto di 
‚Ç¨${formatNumber(companyData.investimentoRichiesto)} ha l'obiettivo di generare un 
ROI del ${companyData.ritornoInvestimento}% in ${companyData.tempiRealizzazione} mesi.

ANALISI DI MERCATO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Settore: ${companyData.settore}
‚Ä¢ Mercato target: ${companyData.mercatoTarget}
‚Ä¢ Crescita prevista 2025: ${companyData.crescitaPrevista}%
‚Ä¢ Posizionamento competitivo: Consolidato

SITUAZIONE FINANZIARIA ATTUALE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
RICAVI:
‚Ä¢ Fatturato 2024: ‚Ç¨${formatNumber(companyData.fatturato2024)}
‚Ä¢ Fatturato 2023: ‚Ç¨${formatNumber(companyData.fatturato2023)}
‚Ä¢ Crescita YoY: ${calculations.crescita?.toFixed(2)}%

COSTI:
‚Ä¢ Costi fissi: ‚Ç¨${formatNumber(companyData.costiFissi)}
‚Ä¢ Costi variabili: ‚Ç¨${formatNumber(companyData.costiVariabili)}
‚Ä¢ EBITDA: ‚Ç¨${formatNumber(calculations.ebitda)}
‚Ä¢ Margine EBITDA: ${calculations.margine?.toFixed(2)}%

PATRIMONIO:
‚Ä¢ Liquidit√†: ‚Ç¨${formatNumber(companyData.liquidita)}
‚Ä¢ Immobilizzazioni: ‚Ç¨${formatNumber(companyData.immobilizzazioni)}
‚Ä¢ Patrimonio netto: ‚Ç¨${formatNumber((parseFloat(companyData.liquidita) + parseFloat(companyData.immobilizzazioni) + parseFloat(companyData.crediti)) - parseFloat(companyData.debiti))}

STRATEGIA DI CRESCITA:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. ESPANSIONE MERCATO
   ‚Ä¢ Target: ${companyData.mercatoTarget}
   ‚Ä¢ Canali: Multi-channel approach
   ‚Ä¢ Timeline: ${companyData.tempiRealizzazione} mesi

2. INNOVAZIONE PRODOTTO/SERVIZIO
   ‚Ä¢ Investimento R&D: 15% del budget
   ‚Ä¢ Focus: Digitalizzazione e sostenibilit√†
   ‚Ä¢ Differenziazione competitiva

3. OTTIMIZZAZIONE OPERATIVA
   ‚Ä¢ Riduzione costi: 8-12%
   ‚Ä¢ Aumento produttivit√†: 15-20%
   ‚Ä¢ Miglioramento qualit√†

PROIEZIONI FINANZIARIE 2025-2027:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
2025: Revenue ‚Ç¨${formatNumber(parseFloat(companyData.fatturato2024) * (1 + parseFloat(companyData.crescitaPrevista)/100))}
2026: Revenue ‚Ç¨${formatNumber(parseFloat(companyData.fatturato2024) * Math.pow(1 + parseFloat(companyData.crescitaPrevista)/100, 2))}
2027: Revenue ‚Ç¨${formatNumber(parseFloat(companyData.fatturato2024) * Math.pow(1 + parseFloat(companyData.crescitaPrevista)/100, 3))}

ANALISI RISCHI E MITIGAZIONE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Rischio mercato: MEDIO - Diversificazione geografica
‚Ä¢ Rischio competitivo: BASSO - Barriere all'entrata elevate
‚Ä¢ Rischio finanziario: BASSO - Posizione patrimoniale solida
‚Ä¢ Rischio operativo: CONTROLLATO - Team esperti e processi consolidati`;
        }

        function generateCashflowDocument() {
            return `RENDICONTO FINANZIARIO PROFESSIONALE
${companyData.ragioneSociale || '[Nome Azienda]'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

SITUAZIONE FINANZIARIA CORRENTE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ATTIVIT√Ä:
‚Ä¢ Liquidit√† immediata: ‚Ç¨${formatNumber(companyData.liquidita)}
‚Ä¢ Crediti verso clienti: ‚Ç¨${formatNumber(companyData.crediti)}
‚Ä¢ Immobilizzazioni: ‚Ç¨${formatNumber(companyData.immobilizzazioni)}
‚Ä¢ TOTALE ATTIVIT√Ä: ‚Ç¨${formatNumber((parseFloat(companyData.liquidita) || 0) + (parseFloat(companyData.crediti) || 0) + (parseFloat(companyData.immobilizzazioni) || 0))}

PASSIVIT√Ä:
‚Ä¢ Debiti totali: ‚Ç¨${formatNumber(companyData.debiti)}
‚Ä¢ Patrimonio netto: ‚Ç¨${formatNumber(((parseFloat(companyData.liquidita) || 0) + (parseFloat(companyData.crediti) || 0) + (parseFloat(companyData.immobilizzazioni) || 0)) - (parseFloat(companyData.debiti) || 0))}

FLUSSI OPERATIVI 2024:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Ricavi totali: ‚Ç¨${formatNumber(companyData.fatturato2024)}
‚Ä¢ Costi operativi: ‚Ç¨${formatNumber((parseFloat(companyData.costiFissi) || 0) + (parseFloat(companyData.costiVariabili) || 0))}
‚Ä¢ EBITDA: ‚Ç¨${formatNumber(calculations.ebitda)}
‚Ä¢ Margine EBITDA: ${calculations.margine?.toFixed(2)}%

ANALISI TREND:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Crescita 2023-2024: ${calculations.crescita?.toFixed(2)}%
‚Ä¢ Performance vs settore: ${calculations.crescita > 10 ? 'SUPERIORE' : calculations.crescita > 5 ? 'IN LINEA' : 'DA MIGLIORARE'}
‚Ä¢ Qualit√† degli utili: ${calculations.margine > 15 ? 'ELEVATA' : calculations.margine > 10 ? 'BUONA' : 'DA OTTIMIZZARE'}

FLUSSI DI INVESTIMENTO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Investimento progetto: ‚Ç¨${formatNumber(companyData.investimentoRichiesto)}
‚Ä¢ ROI atteso: ${companyData.ritornoInvestimento}%
‚Ä¢ Payback period: ${Math.round((parseFloat(companyData.investimentoRichiesto) || 0) / ((calculations.ebitda || 0) / 12 * (parseFloat(companyData.crescitaPrevista) || 10) / 100))} mesi

PROIEZIONE CASSA 12 MESI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Cassa iniziale: ‚Ç¨${formatNumber(companyData.liquidita)}
‚Ä¢ Flussi operativi: ‚Ç¨${formatNumber(calculations.ebitda)}
‚Ä¢ Investimenti: ‚Ç¨${formatNumber(companyData.investimentoRichiesto)}
‚Ä¢ Cassa finale stimata: ‚Ç¨${formatNumber(calculations.cash12)}

INDICATORI FINANZIARI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Liquidit√† corrente: ${((parseFloat(companyData.liquidita) || 0) / (parseFloat(companyData.debiti) || 1)).toFixed(2)}
‚Ä¢ Debt/Equity ratio: ${((parseFloat(companyData.debiti) || 0) / (((parseFloat(companyData.liquidita) || 0) + (parseFloat(companyData.immobilizzazioni) || 0)) - (parseFloat(companyData.debiti) || 0))).toFixed(2)}
‚Ä¢ ROE potenziale: ${(((calculations.ebitda || 0) / (((parseFloat(companyData.liquidita) || 0) + (parseFloat(companyData.immobilizzazioni) || 0)) - (parseFloat(companyData.debiti) || 0))) * 100).toFixed(2)}%

RACCOMANDAZIONI FINANZIARIE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Mantenere riserva di liquidit√† minima 15% del fatturato
‚úÖ Implementare controllo di gestione mensile
‚úÖ Ottimizzare tempi di incasso crediti (-10 giorni target)
‚úÖ Valutare finanziamenti agevolati per crescita
‚úÖ Diversificare fonti di ricavo per stabilit√† flussi`;
        }

        function generateStudioFattibilita() {
            return `STUDIO DI FATTIBILIT√Ä PROFESSIONALE
${companyData.ragioneSociale || '[Nome Azienda]'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

OBIETTIVO DELLO STUDIO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Valutazione della fattibilit√† economico-finanziaria dell'investimento 
di ‚Ç¨${formatNumber(companyData.investimentoRichiesto)} per il progetto:
${companyData.descrizioneProgetto || 'Progetto di espansione aziendale'}

CONTESTO AZIENDALE:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Settore di attivit√†: ${companyData.settore}
‚Ä¢ Anni di esperienza: ${companyData.anniAttivita}
‚Ä¢ Organico: ${companyData.dipendenti} dipendenti
‚Ä¢ Fatturato corrente: ‚Ç¨${formatNumber(companyData.fatturato2024)}
‚Ä¢ Marginalit√† attuale: ${calculations.margine?.toFixed(2)}%

ANALISI DI MERCATO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Mercato di riferimento: ${companyData.mercatoTarget}
‚Ä¢ Trend di crescita settore: Positivo
‚Ä¢ Posizionamento competitivo: Consolidato
‚Ä¢ Opportunit√† identificate: Espansione e innovazione

ANALISI TECNICO-OPERATIVA:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ PUNTI DI FORZA:
‚Ä¢ Team di gestione esperto e consolidato
‚Ä¢ Posizione finanziaria solida (liquidit√† ‚Ç¨${formatNumber(companyData.liquidita)})
‚Ä¢ Track record di crescita positivo
‚Ä¢ Know-how tecnico specializzato nel settore ${companyData.settore}

‚ö†Ô∏è AREE DI ATTENZIONE:
‚Ä¢ Necessit√† di monitoraggio costante degli investimenti
‚Ä¢ Gestione dell'incremento organico
‚Ä¢ Controllo della marginalit√† durante l'espansione

ANALISI ECONOMICO-FINANZIARIA:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

INVESTIMENTO RICHIESTO:
‚Ä¢ Capitale necessario: ‚Ç¨${formatNumber(companyData.investimentoRichiesto)}
‚Ä¢ Tempi di realizzo: ${companyData.tempiRealizzazione} mesi
‚Ä¢ ROI atteso: ${companyData.ritornoInvestimento}%

SOSTENIBILIT√Ä FINANZIARIA:
‚Ä¢ Patrimonio disponibile: ‚Ç¨${formatNumber(((parseFloat(companyData.liquidita) || 0) + (parseFloat(companyData.immobilizzazioni) || 0)) - (parseFloat(companyData.debiti) || 0))}
‚Ä¢ Capacit√† di autofinanziamento: ‚Ç¨${formatNumber(calculations.ebitda)} annui
‚Ä¢ Coverage ratio: ${((calculations.ebitda || 0) / (parseFloat(companyData.investimentoRichiesto) || 1) * 12).toFixed(2)}

ANALISI SCENARI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

SCENARIO BASE (Probabilit√† 70%):
‚Ä¢ Crescita annua: ${companyData.crescitaPrevista}%
‚Ä¢ Revenue incrementale: ‚Ç¨${formatNumber(parseFloat(companyData.fatturato2024) * (parseFloat(companyData.crescitaPrevista) || 10) / 100)}
‚Ä¢ EBITDA incrementale: ‚Ç¨${formatNumber(calculations.ebitda * (parseFloat(companyData.crescitaPrevista) || 10) / 100)}
‚Ä¢ Break-even: Mese ${Math.round((parseFloat(companyData.investimentoRichiesto) || 0) / ((calculations.ebitda || 0) / 12))}

SCENARIO CONSERVATIVO (Probabilit√† 20%):
‚Ä¢ Crescita ridotta: ${(parseFloat(companyData.crescitaPrevista) || 10) * 0.6}%
‚Ä¢ Break-even: Mese ${Math.round((parseFloat(companyData.investimentoRichiesto) || 0) / ((calculations.ebitda || 0) / 12 * 0.6))}

SCENARIO OTTIMISTICO (Probabilit√† 10%):
‚Ä¢ Crescita accelerata: ${(parseFloat(companyData.crescitaPrevista) || 10) * 1.5}%
‚Ä¢ Break-even: Mese ${Math.round((parseFloat(companyData.investimentoRichiesto) || 0) / ((calculations.ebitda || 0) / 12 * 1.5))}

ANALISI DEI RISCHI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

RISCHI IDENTIFICATI:
üü° Rischio di mercato: MEDIO
   - Cambiamenti nelle preferenze clienti
   - Intensificazione competizione
   - Mitigazione: Diversificazione prodotto/geografia

üü¢ Rischio finanziario: BASSO
   - Situazione patrimoniale solida
   - Flussi di cassa stabili
   - Accesso al credito garantito

üü° Rischio operativo: MEDIO
   - Gestione della crescita
   - Scalabilit√† processi
   - Mitigazione: Investment in sistemi e formazione

CONCLUSIONI E RACCOMANDAZIONI:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ VALUTAZIONE FINALE: FATTIBILIT√Ä ELEVATA

MOTIVAZIONI:
‚Ä¢ Solida base patrimoniale e finanziaria
‚Ä¢ Management team esperto e affidabile  
‚Ä¢ Mercato target in crescita
‚Ä¢ ROI atteso superiore al costo del capitale
‚Ä¢ Rischi mitigabili e controllabili

RACCOMANDAZIONI IMPLEMENTATIVE:
1. Procedere con l'investimento secondo timeline proposta
2. Implementare sistema di monitoraggio KPI mensile
3. Mantenere riserva di liquidit√† 20% per imprevisti
4. Valutare partnership strategiche per accelerare crescita
5. Pianificare exit strategy per massimizzare valore

PROBABILIT√Ä DI SUCCESSO: 85%`;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function updateFormData(fieldName, value) {
            companyData[fieldName] = value;
            saveToStorage();
            updateCalculations();
            updatePreview();
        }

        function updateCalculations() {
            const f24 = parseFloat(companyData.fatturato2024) || 0;
            const f23 = parseFloat(companyData.fatturato2023) || 0;
            const costiFissi = parseFloat(companyData.costiFissi) || 0;
            const costiVariabili = parseFloat(companyData.costiVariabili) || 0;
            const liquidita = parseFloat(companyData.liquidita) || 1;

            const ebitda = f24 - costiFissi - costiVariabili;
            const margine = f24 > 0 ? ((ebitda / f24) * 100) : 0;
            const crescita = f23 > 0 ? (((f24 - f23) / f23) * 100) : 0;
            
            const crescitaMensile = (parseFloat(companyData.crescitaPrevista) || 5) / 100 / 12;
            let cashProjection = liquidita;
            for (let i = 0; i < 12; i++) {
                cashProjection += (ebitda / 12) * (1 + crescitaMensile * i);
            }

            calculations = {
                ebitda: ebitda,
                margine: margine,
                crescita: crescita,
                cash12: cashProjection
            };

            // Update KPI display
            document.getElementById('kpiEbitda').textContent = formatCurrency(ebitda);
            document.getElementById('kpiGrowth').textContent = crescita.toFixed(1) + '%';
            document.getElementById('kpiMargin').textContent = margine.toFixed(1) + '%';
            document.getElementById('kpiCash').textContent = formatCurrency(cashProjection);
        }

        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed', 'inactive');
                if (index === currentStep) {
                    step.classList.add('active');
                } else if (index < currentStep) {
                    step.classList.add('completed');
                    step.innerHTML = '‚úì';
                } else {
                    step.classList.add('inactive');
                    step.innerHTML = index + 1;
                }
            });

            const progress = ((currentStep + 1) / 4) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentStep === 0;
            
            if (currentStep === 3) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'inline-flex';
                nextBtn.disabled = false;
            }
        }

        function nextStep() {
            if (currentStep < 3) {
                currentStep++;
                renderStep();
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }

        function updatePreview() {
            const activeType = document.querySelector('.doc-type-btn.active')?.dataset.type || 'analisi';
            const previewContent = document.getElementById('previewContent');
            
            let content = '';
            
            switch(activeType) {
                case 'analisi':
                    content = generateAnalisiDifferenziale();
                    break;
                case 'bp':
                    content = generateBusinessPlan();
                    break;
                case 'cashflow':
                    content = generateCashflowDocument();
                    break;
                case 'fattibilita':
                    content = generateStudioFattibilita();
                    break;
            }
            
            previewContent.textContent = content.substring(0, 800) + (content.length > 800 ? '...' : '');
        }

        function generateCashflowTable() {
            const months = 12;
            const fatturatMensile = (parseFloat(companyData.fatturato2024) || 0) / 12;
            const costiMensili = ((parseFloat(companyData.costiFissi) || 0) + (parseFloat(companyData.costiVariabili) || 0)) / 12;
            const crescitaMensile = (parseFloat(companyData.crescitaPrevista) || 5) / 100 / 12;
            
            let html = `
                <table class="cashflow-table">
                    <thead>
                        <tr>
                            <th>Mese</th>
                            <th>Ricavi</th>
                            <th>Costi</th>
                            <th>EBITDA</th>
                            <th>Investimenti</th>
                            <th>Flusso Netto</th>
                            <th>Cassa Cumulata</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let cassaCumulata = parseFloat(companyData.liquidita) || 0;
            
            for (let i = 1; i <= months; i++) {
                const ricaviMese = fatturatMensile * (1 + crescitaMensile * (i - 1));
                const costiMese = costiMensili;
                const ebitdaMese = ricaviMese - costiMese;
                const investimenti = i === 1 ? (parseFloat(companyData.investimentoRichiesto) || 0) : 0;
                const flussoNetto = ebitdaMese - investimenti;
                cassaCumulata += flussoNetto;

                html += `
                    <tr>
                        <td>${i}</td>
                        <td>‚Ç¨${formatNumber(ricaviMese)}</td>
                        <td>‚Ç¨${formatNumber(costiMese)}</td>
                        <td>‚Ç¨${formatNumber(ebitdaMese)}</td>
                        <td>‚Ç¨${formatNumber(investimenti)}</td>
                        <td>‚Ç¨${formatNumber(flussoNetto)}</td>
                        <td>‚Ç¨${formatNumber(cassaCumulata)}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        // ============================================
        // STORAGE FUNCTIONS
        // ============================================

        function saveData() {
            localStorage.setItem('businessPlanData', JSON.stringify(companyData));
            alert('‚úÖ Dati salvati nel browser');
        }

        function loadData() {
            const saved = localStorage.getItem('businessPlanData');
            if (saved) {
                companyData = JSON.parse(saved);
                renderStep();
                updateCalculations();
                updatePreview();
                alert('‚úÖ Dati caricati con successo');
            } else {
                alert('‚ùå Nessun dato salvato trovato');
            }
        }

        function saveToStorage() {
            localStorage.setItem('businessPlanData', JSON.stringify(companyData));
        }

        function loadStoredData() {
            const saved = localStorage.getItem('businessPlanData');
            if (saved) {
                companyData = JSON.parse(saved);
            }
        }

        function exportJSON() {
            const data = JSON.stringify(companyData, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `business_plan_data_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    companyData = {...companyData, ...imported};
                    renderStep();
                    updateCalculations();
                    updatePreview();
                    saveToStorage();
                    alert('‚úÖ Dati importati con successo');
                } catch (error) {
                    alert('‚ùå File non valido');
                }
            };
            reader.readAsText(file);
        }

        function resetAll() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                localStorage.removeItem('businessPlanData');
                location.reload();
            }
        }

        function formatNumber(value) {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('it-IT', {maximumFractionDigits: 0});
        }

        function formatCurrency(value) {
            const num = parseFloat(value) || 0;
            return '‚Ç¨' + num.toLocaleString('it-IT', {maximumFractionDigits: 0});
        }

        function downloadPDF(docIndex) {
            if (!window.jspdf) {
                alert('‚ùå Funzione PDF non disponibile');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = generatedDocs[docIndex];
            const pdf = new jsPDF();
            
            // Title
            pdf.setFontSize(18);
            pdf.text(doc.name, 20, 30);
            
            // Company name
            pdf.setFontSize(14);
            pdf.text(companyData.ragioneSociale || 'Azienda', 20, 45);
            
            // Date
            pdf.setFontSize(10);
            pdf.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 20, 55);
            
            // Content
            pdf.setFontSize(10);
            const lines = pdf.splitTextToSize(doc.content, 170);
            pdf.text(lines, 20, 70);
            
            // Download
            pdf.save(`${doc.name.replace(/\s+/g, '_')}_${(companyData.ragioneSociale || 'Azienda').replace(/\s+/g, '_')}.pdf`);
            
            alert(`üì• PDF "${doc.name}" scaricato con successo!`);
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            loadStoredData();
            renderStep();
            updateCalculations();
            updatePreview();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Document type selector
            document.querySelectorAll('.doc-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.doc-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updatePreview();
                });
            });
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
